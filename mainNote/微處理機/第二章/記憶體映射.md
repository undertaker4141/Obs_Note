# 記憶體映射

## ARM 記憶體映射概念

ARM 處理器採用記憶體映射 I/O (Memory-Mapped I/O) 架構，這意味著記憶體和週邊設備共用同一個位址空間。在 ARM Cortex-M 處理器中，整個位址空間為 4GB (2^32 位址)。

## 主要記憶體區域

ARM Cortex-M 處理器的記憶體映射通常包含以下主要區域：

### 程式碼區域 (Code Region)

- **Flash ROM**：
  - 儲存程式碼和常數
  - 非揮發性記憶體 (斷電後資料不會遺失)
  - 通常位於位址 0x00000000 開始的區域
  - 執行時間較慢，但成本較低

### 資料區域 (Data Region)

- **SRAM**：
  - 儲存變數和堆疊
  - 揮發性記憶體 (斷電後資料會遺失)
  - 通常位於位址 0x20000000 開始的區域
  - 執行時間較快，但成本較高

### 週邊區域 (Peripheral Region)

- **I/O 暫存器**：
  - 控制硬體週邊設備
  - 通常位於位址 0x40000000 開始的區域
  - 包含 GPIO、UART、SPI、I2C、Timer 等週邊的控制暫存器

### 系統區域 (System Region)

- **系統控制暫存器**：
  - 控制處理器核心功能
  - 通常位於位址 0xE0000000 開始的區域
  - 包含 NVIC (巢狀向量中斷控制器)、SysTick 定時器等

## STM32F103 記憶體映射範例

以 STM32F103C8T6 (Blue Pill) 為例，其記憶體映射如下：

- **Flash**：64 KB (0x08000000 - 0x0800FFFF)
  - 注意：Flash 同時映射到 0x00000000 (啟動時)
  
- **SRAM**：20 KB (0x20000000 - 0x20004FFF)

- **週邊**：
  - GPIO A-E：0x40010800 - 0x40011C00
  - UART1-3：0x40013800 - 0x40004C00
  - SPI1-2：0x40013000 - 0x40003800
  - I2C1-2：0x40005400 - 0x40005C00
  - Timer1-4：0x40012C00 - 0x40000C00
  - ADC1-2：0x40012400 - 0x40012800

## 記憶體映射的優點

1. **統一的位址空間**：
   - CPU 使用相同的指令集存取記憶體和 I/O 裝置
   - 簡化了程式設計模型

2. **彈性**：
   - 可以輕鬆重新分配記憶體和 I/O 資源
   - 支援記憶體映射檔案等進階功能

3. **效能**：
   - 直接存取 I/O 裝置，無需特殊 I/O 指令
   - 可以使用記憶體快取機制加速 I/O 操作

## 記憶體映射的使用

在組合語言中，可以使用載入/儲存指令直接存取記憶體映射的裝置：

```assembly
; 讀取 GPIOC 的輸入資料暫存器 (IDR)
LDR R0, =0x40011000   ; GPIOC 基底位址
LDR R1, [R0, #0x08]   ; 讀取 IDR (偏移量 0x08)

; 寫入 GPIOC 的輸出資料暫存器 (ODR)
LDR R0, =0x40011000   ; GPIOC 基底位址
MOV R1, #0x2000       ; 設定 PC13 為高電位 (1<<13)
STR R1, [R0, #0x0C]   ; 寫入 ODR (偏移量 0x0C)
```

## 返回

- [[ARM架構與組合語言程式設計|返回第二章目錄]]
- [[微處理機概述|返回微處理機概述]]
