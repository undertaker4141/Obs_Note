# 基本指令集

ARM Cortex-M 處理器主要使用 Thumb-2 指令集，這是一種混合 16/32 位元指令的指令集，旨在提高程式碼密度同時保持良好的效能。本節介紹一些基本的 ARM 組合語言指令。

## 資料移動指令

### MOV 指令

`MOV` 指令用於將資料從來源操作數複製到目的暫存器。

**語法**：
```assembly
MOV Rd, Op2
```

其中：
- `Rd` 是目的暫存器
- `Op2` 可以是暫存器 (`Rm`) 或立即值 (`#value`)

**範例**：
```assembly
MOV R0, R1        ; 將 R1 的值複製到 R0
MOV R2, #42       ; 將立即值 42 載入到 R2
```

### 立即值限制

在 ARM Thumb 模式中，立即值通常有大小限制：
- 以 `#` 開頭
- 預設為十進制，使用 `0x` 前綴表示十六進制
- 通常限制為 8 位元大小 (0-255)，載入 32 位元暫存器時高位補零

### LDR 偽指令

對於無法直接用 MOV 載入的大立即值，可以使用 `LDR` 偽指令：

```assembly
LDR Rd, =value
```

這是一個偽指令 (Pseudo-instruction)，組譯器會根據值的大小選擇：
- 如果值可以用 MOV 表示，則轉換為 MOV 指令
- 如果值太大，會將其儲存在文字池 (Literal Pool) 中，再用 PC 相對定址載入

## 算術指令

### 加法指令

```assembly
ADD Rd, Rn, Op2   ; Rd = Rn + Op2
```

其中 `Op2` 可以是暫存器或立即值。

**範例**：
```assembly
ADD R0, R1, R2    ; R0 = R1 + R2
ADD R3, R3, #1    ; R3 = R3 + 1 (遞增 R3)
```

### 減法指令

```assembly
SUB Rd, Rn, Op2   ; Rd = Rn - Op2
```

**範例**：
```assembly
SUB R0, R1, R2    ; R0 = R1 - R2
SUB R3, R3, #1    ; R3 = R3 - 1 (遞減 R3)
```

## 資料格式表示

ARM 組合語言支援多種數值表示格式：

- **十六進制**：使用 `0x` 前綴，如 `0x1A`
- **十進制**：直接寫數字，如 `42`
- **二進制**：使用 `0b` 前綴，如 `0b1010`
- **八進制**：使用 `0` 前綴，如 `052`
- **ASCII 字元**：用單引號括起來，如 `'A'`

## 組譯器指令

組譯器指令 (Assembler Directives) 是給組譯器的指示，不是 CPU 指令。常見的組譯器指令包括：

### 區段定義

```assembly
AREA sectionname, attribute, ...
```

用於定義程式區段及其屬性，如：
- `AREA CODE, READONLY, CODE`：定義程式碼區段
- `AREA DATA, READWRITE, ALIGN=2`：定義資料區段

### 符號匯出/匯入

```assembly
EXPORT symbol   ; 匯出符號，使其可被其他檔案使用
IMPORT symbol   ; 匯入其他檔案定義的符號
```

### 常數定義

```assembly
EQU name value   ; 定義符號常數或位址別名
```

**範例**：
```assembly
GPIO_BASE EQU 0x40010800   ; 定義 GPIO 基底位址常數
```

### 資料定義

```assembly
DCB value(s)   ; 定義位元組 (8 位元) 常數
DCW value(s)   ; 定義半字 (16 位元) 常數
DCD value(s)   ; 定義字 (32 位元) 常數
```

**範例**：
```assembly
MyData  DCB 10, 20, 30     ; 定義 3 個位元組常數
MyArray DCD 0, 1, 2, 3     ; 定義 4 個字常數
```

### 空間配置

```assembly
SPACE size   ; 配置未初始化的記憶體空間
```

### 對齊

```assembly
ALIGN n   ; 確保後續資料或指令對齊到 2^n 的位元組邊界
```

## 標籤規則

標籤用於標識程式中的位置，可以被跳轉指令引用。標籤規則：

- 必須是唯一的
- 可以包含字母、數字和底線
- 必須以字母或底線開頭
- 不能使用保留字
- 通常以冒號結尾 (在某些組譯器中可選)

**範例**：
```assembly
Loop:
    ADD R0, R0, #1
    CMP R0, #10
    BNE Loop      ; 跳轉回 Loop 標籤
```

## 註解

在 ARM 組合語言中，註解使用分號 (`;`) 開始，一直延伸到行尾：

```assembly
MOV R0, #0    ; 初始化 R0 為 0
```

## 返回

- [[ARM架構與組合語言程式設計|返回第二章目錄]]
- [[微處理機概述|返回微處理機概述]]
