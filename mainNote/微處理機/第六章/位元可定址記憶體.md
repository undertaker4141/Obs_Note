# 位元可定址記憶體

本節介紹 ARM Cortex-M 處理器中的位元可定址記憶體 (Bit-Addressable Memory) 和位元綁定 (Bit-Banding) 功能。

## 位元可定址記憶體概念

位元可定址記憶體是一種特殊的記憶體區域，允許對單個位元進行原子操作 (讀取、設置、清除)，而不需要讀取-修改-寫入 (Read-Modify-Write, RMW) 序列。

在 ARM Cortex-M3/M4 處理器中，這是通過位元綁定 (Bit-Banding) 機制實現的。

## 位元綁定 (Bit-Banding) 機制

位元綁定是 ARM Cortex-M3/M4 處理器的一個特性，它將特定記憶體區域的每一個位元映射到一個 32 位元字的位址空間。

### 位元綁定區域

Cortex-M3/M4 有兩個位元綁定區域：

1. **SRAM 位元區 (SRAM Bit-Band Region)**：
   - 位元區：0x20000000 - 0x200FFFFF (1MB)
   - 別名區：0x22000000 - 0x23FFFFFF (32MB)

2. **週邊位元區 (Peripheral Bit-Band Region)**：
   - 位元區：0x40000000 - 0x400FFFFF (1MB)
   - 別名區：0x42000000 - 0x43FFFFFF (32MB)

### 位元綁定的工作原理

位元綁定的工作原理如下：

1. 位元區中的**每一位元**都映射到別名區中的**一個字 (32 位元)**
2. 對別名區中的字進行寫入操作時，只有最低位 (bit 0) 有效，它會被原子地寫入到對應的位元
3. 從別名區中讀取時，返回的字的最低位反映了對應位元的值，其他位為 0

### 別名位址計算

別名位址的計算公式為：

```
別名位址 = 別名區基底位址 + (位元組偏移量 × 32) + (位元編號 × 4)
```

其中：
- **別名區基底位址**：SRAM 為 0x22000000，週邊為 0x42000000
- **位元組偏移量**：目標位元組相對於位元區基底位址的偏移量
- **位元編號**：目標位元在位元組中的位置 (0-7)

## 位元綁定的優點

位元綁定機制有以下優點：

1. **原子操作**：
   - 對單個位元的操作是原子的，不會被中斷
   - 避免了在多執行緒或中斷環境中的競爭條件

2. **簡化程式碼**：
   - 不需要讀取-修改-寫入序列
   - 減少了程式碼大小和執行時間

3. **提高效率**：
   - 減少了記憶體存取次數
   - 減少了在關鍵區段中禁用中斷的需求

## 位元綁定的使用範例

### 設置單個位元

```assembly
; 設置 GPIOC 的第 13 位 (PC13)
    LDR R0, =0x42000000 + (0x10C00 * 32) + (13 * 4)  ; GPIOC_ODR 的第 13 位別名位址
    MOV R1, #1
    STR R1, [R0]  ; 原子地設置 PC13
```

在 C 語言中：

```c
// 設置 PC13
*(volatile uint32_t *)(0x42000000 + (0x10C00 * 32) + (13 * 4)) = 1;
```

### 清除單個位元

```assembly
; 清除 GPIOC 的第 13 位 (PC13)
    LDR R0, =0x42000000 + (0x10C00 * 32) + (13 * 4)  ; GPIOC_ODR 的第 13 位別名位址
    MOV R1, #0
    STR R1, [R0]  ; 原子地清除 PC13
```

### 讀取單個位元

```assembly
; 讀取 GPIOC 的第 13 位 (PC13)
    LDR R0, =0x42000000 + (0x10C00 * 32) + (13 * 4)  ; GPIOC_IDR 的第 13 位別名位址
    LDR R1, [R0]  ; R1 = PC13 的值 (0 或 1)
```

### 切換單個位元

```assembly
; 切換 GPIOC 的第 13 位 (PC13)
    LDR R0, =0x42000000 + (0x10C00 * 32) + (13 * 4)  ; GPIOC_ODR 的第 13 位別名位址
    LDR R1, [R0]  ; 讀取目前值
    EOR R1, R1, #1  ; 切換最低位
    STR R1, [R0]  ; 寫回
```

## 位元綁定的實際應用

### 控制 LED

```assembly
; 切換 LED (假設連接到 PC13)
    LDR R0, =0x42000000 + (0x10C00 * 32) + (13 * 4)  ; GPIOC_ODR 的第 13 位別名位址
    LDR R1, [R0]  ; 讀取目前值
    EOR R1, R1, #1  ; 切換最低位
    STR R1, [R0]  ; 寫回
```

### 讀取按鈕狀態

```assembly
; 讀取按鈕狀態 (假設連接到 PA0)
    LDR R0, =0x42000000 + (0x10800 * 32) + (0 * 4)  ; GPIOA_IDR 的第 0 位別名位址
    LDR R1, [R0]  ; R1 = 按鈕狀態 (0 或 1)
    CMP R1, #1
    BEQ ButtonPressed
```

### 設置/清除旗標

```assembly
; 設置旗標 (在 SRAM 中)
    LDR R0, =0x20000000  ; SRAM 基底位址
    LDR R1, =0x22000000 + (0 * 32) + (0 * 4)  ; 第一個位元的別名位址
    MOV R2, #1
    STR R2, [R1]  ; 設置旗標
    
    ; 其他程式碼...
    
    ; 檢查旗標
    LDR R2, [R1]
    CMP R2, #1
    BEQ FlagSet
```

## 位元綁定與傳統位元操作的比較

| 操作 | 位元綁定 | 傳統位元操作 |
|------|---------|------------|
| 設置位元 | `STR R1, [R0]` | `LDR R1, [R0]`<br>`ORR R1, R1, #(1<<n)`<br>`STR R1, [R0]` |
| 清除位元 | `STR R1, [R0]` | `LDR R1, [R0]`<br>`BIC R1, R1, #(1<<n)`<br>`STR R1, [R0]` |
| 讀取位元 | `LDR R1, [R0]` | `LDR R1, [R0]`<br>`AND R1, R1, #(1<<n)`<br>`LSR R1, R1, #n` |
| 原子性 | 原子 | 非原子 (可能被中斷) |
| 程式碼大小 | 小 | 大 |
| 執行時間 | 短 | 長 |

## 位元綁定的限制

位元綁定機制有一些限制：

1. **僅適用於特定區域**：
   - 只有 SRAM 和週邊的前 1MB 支援位元綁定
   - 其他記憶體區域需要使用傳統的位元操作

2. **位址計算複雜**：
   - 別名位址的計算相對複雜
   - 通常需要使用宏或函數來簡化

3. **可能的效能開銷**：
   - 在某些情況下，位元綁定可能比直接操作整個字慢
   - 特別是當需要操作同一個字中的多個位元時

## 返回

- [[ARM定址模式|返回第六章目錄]]
- [[微處理機概述|返回微處理機概述]]
