# 檔案分享

(來源: c9_file_sharing.pdf)

## 簡介

專案協作通常需要資訊分享。在使用電腦系統時，團隊成員必須分享檔案和目錄。本章探討 UNIX 系統中檔案分享的運作方式，重點是如何讓使用者從不同目錄存取同一個檔案，主要討論透過連結 (links) 進行分享。

## 透過連結分享檔案

- 連結 (link) 將共享檔案連接到需要存取它的使用者的目錄項目。
    
- 當一個檔案有 N 個連結時，表示檔案系統中有 N 個目錄項目指向它。
    
- 連結透過提供多個存取相同檔案的路徑來促進分享。
    
- 分享的程度取決於檔案權限的設定。
    
- 可以為沒有任何存取權限的檔案建立連結，但這沒有實際意義。因此，透過連結分享檔案首先要建立存取路徑 (建立連結)，然後設定適當的存取權限。
    

UNIX 支援兩種連結類型：

1. **硬連結 (hard links)**
    
2. **軟連結/符號連結 (soft/symbolic links)**
    

- `ln` 指令可用於建立這兩種連結。
    

## 硬連結 (Hard Links)

- 硬連結是指向檔案 inode 的指標。
    
- 當在 UNIX 中建立檔案時，系統會為該檔案分配一個唯一的 inode，並在建立檔案的目錄中建立一個項目。
    
- 目錄項目包含一個有序對：`(inode 編號, 檔名)`。
    
- 檔案的 inode 編號用於存取其屬性，包括其在磁碟上的內容。
    
- **語法**:
    
    - `ln [options] existing-file new-file` (為 `existing-file` 建立名為 `new-file` 的硬連結)
        
    - `ln [options] existing-file-list directory` (在 `directory` 中為 `existing-file-list` 中的檔案建立同名硬連結)
        
- `ls -il` 指令可以顯示檔案的 inode 編號和連結計數。
    
- 建立硬連結時，會在目錄中新增一個指向相同 inode 的條目，且該 inode 的連結計數 (link count) 會加 1。
    
- 所有硬連結在權限和內容上都是平等的；沒有所謂的「原始」檔案。
    
- 刪除 (`rm`) 一個硬連結時，對應的目錄項目會被移除，inode 的連結計數減 1。
    
    - 如果連結計數變為 0，系統會釋放 inode 和檔案所佔用的磁碟區塊。
        
    - 如果連結計數不為 0，檔案內容和 inode 仍然存在，可透過其他硬連結存取。
        

### 硬連結的缺點

1. **不能跨檔案系統 (file system) 建立硬連結**：因為 inode 編號在單一檔案系統內是唯一的。
    
    - 嘗試這樣做會導致 "Cross-device link" 錯誤。
        
    - 移動具有多個硬連結的檔案到不同檔案系統時，原始連結會斷開，目標位置會建立一個新的獨立檔案 (新的 inode)。
        
2. **只有超級使用者 (superuser) 可以為目錄建立硬連結**：普通使用者嘗試為目錄建立硬連結會失敗。
    

## 軟連結/符號連結 (Symbolic Links)

- 軟連結 (或符號連結) 解決了硬連結的限制。
    
- **語法**: `ln -s existing-file new-file` (為 `existing-file` 建立名為 `new-file` 的符號連結)
    
- **特性**:
    
    - 符號連結是一個特殊類型的檔案 (類型為 `l`)，其內容是它所指向的目標檔案的路徑名稱。
        
    - 符號連結本身有自己的 inode 編號，與目標檔案的 inode 不同。
        
    - 建立符號連結不會改變目標檔案的連結計數。
        
    - 符號連結的檔案大小是其儲存的目標路徑名稱的長度。
        
    - `ls -l` 的輸出會顯示 `link_name -> target_path`。
        
- **優點**:
    
    - 可以跨檔案系統建立符號連結。
        
    - 可以為目錄建立符號連結。
        
- **運作方式**: 當系統存取符號連結時，它會讀取連結檔案的內容 (即目標路徑)，然後存取該路徑指向的實際檔案或目錄。
    

### 符號連結的優缺點

- **優點**:
    
    - 解決了硬連結不能跨檔案系統和不能連結目錄的問題。
        
    - 非常靈活，甚至可以跨機器和網路連結檔案 (需網路檔案系統支援)。
        
- **缺點**:
    
    - **懸空連結 (Dangling Link)**: 如果目標檔案被移動或刪除，符號連結仍然存在，但它指向一個不存在的路徑，導致連結失效。
        
    - **額外開銷**:
        
        - 需要一個額外的 inode 來儲存符號連結本身。
            
        - 需要磁碟空間來儲存目標檔案的路徑名稱。
            
    - **較慢的存取速度**: 存取符號連結時，系統需要先讀取連結檔案以獲取目標路徑，然後再存取目標檔案，這通常涉及額外的磁碟存取。
        

[[Unix學習筆記_總覽]]