# 查詢表

本節介紹查詢表 (Look-Up Table, LUT) 的概念和實現方法，以及如何在 ARM 處理器中使用查詢表。

## 查詢表概念

查詢表是一種將預先計算好的結果儲存在記憶體中的資料結構，程式可以通過索引直接查詢結果，而不需要即時計算。查詢表通常用於：

- 加速複雜計算 (如三角函數、對數等)
- 實現函數映射
- 狀態機轉換
- 字元轉換
- 資料壓縮/解壓縮

## 查詢表的優缺點

### 優點

- **速度快**：直接查表比即時計算快
- **確定性**：執行時間固定，適合即時系統
- **簡化程式碼**：複雜計算可以簡化為簡單的表查詢

### 缺點

- **記憶體使用**：需要額外的記憶體空間儲存表
- **精度限制**：表的大小限制了精度
- **初始化開銷**：需要預先計算和初始化表

## ARM 中的查詢表實現

在 ARM 處理器中，查詢表通常使用進階索引定址模式實現，特別是基底暫存器 + 索引暫存器 + 移位的組合。

### 基本查詢表

```assembly
    LDR R0, =Table       ; R0 = 表的基底位址
    MOV R1, #3           ; R1 = 索引 (例如 3)
    LDR R2, [R0, R1, LSL #2]  ; R2 = Table[3] (R0 + R1*4)
```

這裡 `LSL #2` 將索引乘以 4 (左移 2 位)，因為每個表項是 4 位元組 (一個字)。

### 表的定義

查詢表可以在組合語言中定義如下：

```assembly
    AREA MyData, DATA, READONLY
    
Table
    DCD 0, 1, 4, 9, 16, 25, 36, 49, 64, 81  ; 平方表 (0^2 到 9^2)
```

或者在 C 語言中定義：

```c
const uint32_t Table[] = {0, 1, 4, 9, 16, 25, 36, 49, 64, 81};
```

### 範圍檢查

在使用查詢表前，通常需要檢查索引是否在有效範圍內：

```assembly
    LDR R0, =Table       ; R0 = 表的基底位址
    MOV R1, #3           ; R1 = 索引 (例如 3)
    
    CMP R1, #10          ; 比較索引和表大小
    BGE OutOfRange       ; 如果索引 >= 10，超出範圍
    
    LDR R2, [R0, R1, LSL #2]  ; R2 = Table[3]
    B Done
    
OutOfRange:
    ; 處理超出範圍的情況
    MOV R2, #-1          ; 返回錯誤值
    
Done:
```

## 查詢表應用範例

### 三角函數表

```assembly
    AREA MyData, DATA, READONLY
    
SinTable
    ; 儲存 sin(0°) 到 sin(90°)，每 5° 一個值，乘以 1000 以避免浮點數
    DCD 0, 87, 174, 259, 342, 423, 500, 574, 643, 707
    DCD 766, 819, 866, 906, 940, 966, 985, 996, 1000
```

使用三角函數表：

```assembly
    ; 計算 sin(angle)，其中 angle 是 0-90 度
    LDR R0, =SinTable    ; R0 = 表的基底位址
    MOV R1, R4           ; R1 = 角度 (例如 30°)
    
    ; 將角度轉換為表索引 (每 5° 一個值)
    MOV R2, #5
    UDIV R1, R1, R2      ; R1 = 角度 / 5
    
    ; 檢查範圍
    CMP R1, #19          ; 比較索引和表大小
    BGE OutOfRange       ; 如果索引 >= 19，超出範圍
    
    ; 查表
    LDR R2, [R0, R1, LSL #2]  ; R2 = SinTable[angle/5]
    
    ; R2 現在包含 sin(angle) * 1000
```

### 字元轉換表

```assembly
    AREA MyData, DATA, READONLY
    
UpperToLowerTable
    ; ASCII 'A' 到 'Z' 的小寫轉換表 (偏移量 'A' = 65)
    DCB 'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j'
    DCB 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't'
    DCB 'u', 'v', 'w', 'x', 'y', 'z'
```

使用字元轉換表：

```assembly
    ; 將大寫字母轉換為小寫
    LDR R0, =UpperToLowerTable  ; R0 = 表的基底位址
    MOV R1, #'C'                ; R1 = 輸入字元 'C'
    
    ; 檢查是否為大寫字母
    CMP R1, #'A'
    BLT NotUppercase
    CMP R1, #'Z'
    BGT NotUppercase
    
    ; 計算索引
    SUB R2, R1, #'A'            ; R2 = 字元 - 'A'
    
    ; 查表
    LDRB R3, [R0, R2]           ; R3 = UpperToLowerTable[字元-'A']
    
    ; R3 現在包含對應的小寫字母 'c'
    B Done
    
NotUppercase:
    MOV R3, R1                  ; 不是大寫字母，保持不變
    
Done:
```

### 狀態機轉換表

```assembly
    AREA MyData, DATA, READONLY
    
StateTransitionTable
    ; 狀態機轉換表：[目前狀態 * 輸入數量 + 輸入] = 下一個狀態
    ; 假設 4 個狀態 (0-3) 和 3 個可能的輸入 (0-2)
    DCB 1, 2, 0  ; 狀態 0 的轉換
    DCB 0, 1, 3  ; 狀態 1 的轉換
    DCB 3, 2, 1  ; 狀態 2 的轉換
    DCB 2, 0, 3  ; 狀態 3 的轉換
```

使用狀態機轉換表：

```assembly
    ; 狀態機轉換
    LDR R0, =StateTransitionTable  ; R0 = 表的基底位址
    MOV R1, #1                     ; R1 = 目前狀態 (例如 1)
    MOV R2, #2                     ; R2 = 輸入 (例如 2)
    
    ; 檢查範圍
    CMP R1, #4
    BGE InvalidState
    CMP R2, #3
    BGE InvalidInput
    
    ; 計算索引：狀態 * 輸入數量 + 輸入
    MOV R3, #3
    MUL R4, R1, R3                 ; R4 = 狀態 * 3
    ADD R4, R4, R2                 ; R4 = 狀態 * 3 + 輸入
    
    ; 查表
    LDRB R5, [R0, R4]              ; R5 = StateTransitionTable[狀態*3+輸入]
    
    ; R5 現在包含下一個狀態 (3)
    B Done
    
InvalidState:
InvalidInput:
    ; 處理無效狀態或輸入
    MOV R5, #0                     ; 預設為狀態 0
    
Done:
```

## 多維查詢表

多維查詢表可以使用索引計算或巢狀查詢實現：

### 二維表索引計算

```assembly
    ; 存取二維表 Table[row][col]
    LDR R0, =Table       ; R0 = 表的基底位址
    MOV R1, #2           ; R1 = 行索引 (例如 2)
    MOV R2, #3           ; R2 = 列索引 (例如 3)
    MOV R3, #5           ; R3 = 每行的元素數 (例如 5)
    
    MUL R4, R1, R3       ; R4 = 行索引 * 每行元素數
    ADD R4, R4, R2       ; R4 = 行索引 * 每行元素數 + 列索引
    
    LDR R5, [R0, R4, LSL #2]  ; R5 = Table[2][3]
```

## 返回

- [[ARM定址模式|返回第六章目錄]]
- [[微處理機概述|返回微處理機概述]]
