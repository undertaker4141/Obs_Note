# 組合語言結構

## 組合語言基本結構

ARM 組合語言程式由一系列指令和組譯器指令組成，每行通常遵循以下格式：

```
[label] opcode [operands] [; comment]
```

其中：
- **label**：可選的標籤，用於標識程式中的位置
- **opcode**：操作碼，指定要執行的操作
- **operands**：操作數，指定操作的資料來源和目的地
- **comment**：註解，以分號 (`;`) 開始

## 程式結構範例

以下是一個簡單的 ARM 組合語言程式範例：

```assembly
    AREA Example, CODE, READONLY
    ENTRY
    EXPORT __main

__main
    ; 初始化
    MOV R0, #0          ; 初始化 R0 為 0
    MOV R1, #10         ; 設定計數器為 10
    
Loop
    ADD R0, R0, #1      ; R0 = R0 + 1
    SUBS R1, R1, #1     ; 遞減計數器並更新旗標
    BNE Loop            ; 如果 R1 != 0，繼續迴圈
    
    ; 程式結束
    B .                 ; 無限迴圈
    
    END
```

## 建立可執行檔的流程

從組合語言原始碼到可執行檔的流程包括以下步驟：

1. **編輯**：創建或修改 `.s` 或 `.asm` 檔案
2. **組譯**：將組合語言轉換為目的檔 (`.o`) 和列表檔 (`.lst`)
3. **連結**：將目的檔與函式庫連結，生成可執行檔 (`.axf` 或 `.elf`)
4. **下載/除錯**：將可執行檔下載到目標硬體並執行或除錯

## 指令集

ARM Cortex-M 處理器主要使用 Thumb-2 指令集，這是一種混合 16/32 位元指令的指令集。

### Thumb-2 指令集特點

- **混合 16/32 位元指令**：
  - 16 位元指令提高程式碼密度
  - 32 位元指令提供更強大的功能
  
- **相較於 ARM 指令集**：
  - 程式碼密度更高 (約 70% 大小)
  - 效能略低 (約 85-90%)
  - 在記憶體受限的系統中更有優勢

- **Cortex-M 系列專用**：
  - Cortex-M 處理器只支援 Thumb/Thumb-2 指令集
  - 不支援傳統 32 位元 ARM 指令集

## 程式計數器 (PC) 行為

程式計數器 (PC, R15) 是控制程式執行流程的關鍵暫存器：

- **基本功能**：指向下一個要「提取」的指令
  
- **初始化**：
  - 系統重置時，PC 從位址 0x00000004 載入初始位址
  - 初始位址通常指向 `Reset_Handler`
  
- **自動更新**：
  - 執行指令後，PC 自動增加指向下一個指令
  - 在 Thumb-2 模式下，增加量可能是 2 位元組 (16 位元指令) 或 4 位元組 (32 位元指令)
  
- **手動修改**：
  - 分支指令 (B, BL, BX) 會直接修改 PC 的值
  - 也可以通過 `MOV PC, Rx` 直接修改 PC

- **讀取值**：
  - 在 Thumb-2 模式下，讀取 PC 時，其值通常是「目前指令位址 + 4」
  - 這在使用 PC 相對定址時很重要

## 副程式結構

副程式 (Subroutine) 是可重複使用的程式碼區塊，通常遵循以下結構：

```assembly
MyFunction
    PUSH {R4-R7, LR}    ; 保存被呼叫者保存的暫存器和返回位址
    
    ; 副程式主體
    ...
    
    POP {R4-R7, PC}     ; 恢復暫存器並返回 (將 LR 載入到 PC)
```

使用 `PROC` 和 `ENDP` 指令可以更清晰地標示副程式的開始和結束：

```assembly
MyFunction PROC
    PUSH {R4-R7, LR}
    
    ; 副程式主體
    ...
    
    POP {R4-R7, PC}
    ENDP
```

## 模組化程式設計

大型程式通常分為多個檔案，使用 `IMPORT` 和 `EXPORT` 指令實現跨檔案呼叫：

### 在一個檔案中匯出函式

```assembly
    AREA MyModule, CODE, READONLY
    EXPORT MyFunction    ; 使函式可被其他檔案呼叫

MyFunction
    ; 函式實作
    ...
    BX LR
```

### 在另一個檔案中匯入並呼叫函式

```assembly
    AREA MainModule, CODE, READONLY
    IMPORT MyFunction    ; 宣告外部函式
    
    ; 呼叫外部函式
    BL MyFunction
```

## 返回

- [[ARM架構與組合語言程式設計|返回第二章目錄]]
- [[微處理機概述|返回微處理機概述]]
