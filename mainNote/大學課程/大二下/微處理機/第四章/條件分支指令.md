# 條件分支指令

本節介紹 ARM 處理器中的條件分支指令，包括無條件分支、條件分支以及比較指令。

## 分支指令概述

分支指令用於改變程式的執行流程，使處理器跳轉到不同的程式位址。ARM 提供了多種分支指令，包括無條件分支和條件分支。

## 無條件分支

### B 指令 (Branch)

```assembly
B label    ; 跳轉到 label
```

B 指令執行無條件跳轉，將程式計數器 (PC) 設置為目標位址。這是最基本的分支指令。

**特性**：
- 採用 PC 相對定址
- 跳轉範圍約 ±32MB
- 不影響連結暫存器 (LR)

**範例**：
```assembly
    MOV R0, #0
    B Skip        ; 無條件跳轉到 Skip
    ADD R0, R0, #1    ; 這行不會執行
Skip:
    ADD R0, R0, #2    ; 這行會執行
```

### BX 指令 (Branch and Exchange)

```assembly
BX Rm    ; 跳轉到 Rm 中的位址
```

BX 指令跳轉到暫存器 Rm 中指定的位址。

**特性**：
- 可跳轉到 4GB 位址空間中的任意位址
- Rm 的最低位 (bit 0) 用於切換 ARM/Thumb 狀態 (在 Cortex-M 中固定為 Thumb)
- 常用於返回 (BX LR)

**範例**：
```assembly
    LDR R0, =JumpTarget    ; 載入目標位址
    BX R0                  ; 跳轉到 R0 中的位址
    
JumpTarget:
    ; 目標程式碼
```

## PC 相對定址

ARM 分支指令使用 PC 相對定址，目標位址計算如下：

```
目標位址 = (目前指令位址 + 4) + (偏移量 << 1)
```

其中偏移量是一個有號 24 位元值，左移 1 位後可表示 ±32MB 的範圍。組譯器會自動計算所需的偏移量。

## 條件分支

ARM 提供了一組條件分支指令，根據 CPSR 中的旗標狀態決定是否跳轉。

### 無號數條件分支

- **BEQ** (Equal)：Z=1，相等時跳轉
- **BNE** (Not Equal)：Z=0，不相等時跳轉
- **BCS/BHS** (Carry Set/Higher or Same)：C=1，無借位/大於等於時跳轉
- **BCC/BLO** (Carry Clear/Lower)：C=0，有借位/小於時跳轉
- **BHI** (Higher)：C=1 且 Z=0，大於時跳轉
- **BLS** (Lower or Same)：C=0 或 Z=1，小於等於時跳轉

### 有號數條件分支

- **BMI** (Minus)：N=1，負數時跳轉
- **BPL** (Plus)：N=0，正數或零時跳轉
- **BVS** (Overflow Set)：V=1，溢位時跳轉
- **BVC** (Overflow Clear)：V=0，無溢位時跳轉
- **BGT** (Greater Than)：Z=0 且 N=V，大於時跳轉
- **BLT** (Less Than)：N≠V，小於時跳轉
- **BGE** (Greater or Equal)：N=V，大於等於時跳轉
- **BLE** (Less or Equal)：Z=1 或 N≠V，小於等於時跳轉

## 比較指令

比較指令用於設置 CPSR 中的旗標，通常與條件分支指令配合使用。

### CMP 指令 (Compare)

```assembly
CMP Rn, Op2    ; 比較 Rn 和 Op2 (Rn - Op2)，只更新旗標
```

CMP 指令執行減法操作但不儲存結果，只更新旗標。

**範例**：
```assembly
    CMP R0, #10     ; 比較 R0 和 10
    BEQ Equal       ; 如果 R0 = 10，跳轉到 Equal
    BGT Greater     ; 如果 R0 > 10，跳轉到 Greater
    B Default       ; 否則跳轉到 Default
```

### CMN 指令 (Compare Negative)

```assembly
CMN Rn, Op2    ; 比較 Rn 和 -Op2 (Rn + Op2)，只更新旗標
```

CMN 指令執行加法操作但不儲存結果，只更新旗標。常用於檢查 Rn 是否等於 -Op2。

### TST 指令 (Test)

```assembly
TST Rn, Op2    ; 測試 Rn AND Op2，只更新旗標
```

TST 指令執行位元 AND 操作但不儲存結果，只更新旗標。常用於檢查特定位元是否設置。

**範例**：
```assembly
    TST R0, #0x01   ; 測試 R0 的最低位
    BNE BitSet      ; 如果位元已設置，跳轉到 BitSet
```

### TEQ 指令 (Test Equivalence)

```assembly
TEQ Rn, Op2    ; 測試 Rn EOR Op2，只更新旗標
```

TEQ 指令執行位元 XOR 操作但不儲存結果，只更新旗標。常用於檢查兩個值是否相等。

## 迴圈實現

迴圈是重複執行一段程式碼的結構，可以使用條件分支指令實現。

### 基本迴圈

```assembly
    MOV R0, #10     ; 初始化計數器
Loop:
    ; 迴圈主體
    ...
    SUBS R0, R0, #1 ; 遞減計數器並更新旗標
    BNE Loop        ; 如果 R0 != 0，繼續迴圈
```

### 巢狀迴圈

```assembly
    MOV R0, #5      ; 外層迴圈計數器
OuterLoop:
    MOV R1, #10     ; 內層迴圈計數器
InnerLoop:
    ; 內層迴圈主體
    ...
    SUBS R1, R1, #1 ; 遞減內層計數器
    BNE InnerLoop   ; 如果 R1 != 0，繼續內層迴圈
    
    ; 外層迴圈主體
    ...
    SUBS R0, R0, #1 ; 遞減外層計數器
    BNE OuterLoop   ; 如果 R0 != 0，繼續外層迴圈
```

## 無號數除法實現

以下是使用重複減法實現無號數除法的範例：

```assembly
; R0 = R0 / R1，商存入 R0，餘數存入 R2
    MOV R2, #0      ; 初始化商為 0
    
DivLoop:
    CMP R0, R1      ; 比較被除數和除數
    BLO DivDone     ; 如果被除數 < 除數，結束
    
    SUB R0, R0, R1  ; 被除數 = 被除數 - 除數
    ADD R2, R2, #1  ; 商 = 商 + 1
    B DivLoop       ; 繼續迴圈
    
DivDone:
    MOV R3, R0      ; 餘數 = 最終被除數
    MOV R0, R2      ; 返回商
```

## 條件執行

除了條件分支外，ARM 還支援條件執行，可以在大多數指令後加上條件碼，使指令只在特定條件滿足時才執行。

```assembly
    CMP R0, R1      ; 比較 R0 和 R1
    ADDGT R2, R2, #1 ; 如果 R0 > R1，則 R2 = R2 + 1
    MOVLE R3, #0    ; 如果 R0 <= R1，則 R3 = 0
```

條件執行可以減少分支指令的使用，提高效能，特別是對於簡短的條件程式碼。

## 返回

- [[ARM分支呼叫與迴圈|返回第四章目錄]]
- [[微處理機概述|返回微處理機概述]]
