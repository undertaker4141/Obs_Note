# CPU 暫存器

## 暫存器基本概念

暫存器是 CPU 內部的高速儲存單元，用於暫時儲存資訊（資料或位址）。相較於記憶體，暫存器存取速度更快，是 CPU 執行指令時最常使用的資料儲存位置。

## ARM Cortex-M 暫存器結構

ARM Cortex-M 處理器有 16 個 32 位元的通用暫存器 (R0-R15)。這些暫存器可分為兩類：

### 資料大小定義

- **Word**：32 位元 (4 位元組)
- **Half-word**：16 位元 (2 位元組)
- **Byte**：8 位元 (1 位元組)

ARM 處理器預設處理 32 位元資料。

### 通用暫存器 (GPRs)

R0-R12 是通用暫存器，沒有特殊指定功能，可任意使用。根據 ARM 程序呼叫標準 (AAPCS)，這些暫存器有特定的使用慣例：

- **R0-R3**：用於傳遞參數和返回值，呼叫者不應假設它們在呼叫後會被保留
- **R4-R11**：如果副程式需要使用，必須先保存，返回前恢復 (Callee-saved)
- **R12**：通常用作 Intra-Procedure-call scratch register (IP)

### 特殊功能暫存器 (SFRs)

- **R13 (SP)**：堆疊指標 (Stack Pointer)
  - 指向目前堆疊的頂部
  - ARM 堆疊向下增長 (Push 前 SP 先減)
  
- **R14 (LR)**：連結暫存器 (Link Register)
  - 用於儲存副程式返回位址
  - 當執行 BL (Branch with Link) 指令時，LR 會儲存返回位址
  
- **R15 (PC)**：程式計數器 (Program Counter)
  - 指向下一個要執行的指令位址
  - 在 Thumb-2 模式下，PC 讀取值通常是目前指令位址 + 4
  
- **CPSR**：目前程式狀態暫存器 (Current Program Status Register)
  - 包含條件旗標 (N, Z, C, V)
  - 包含處理器模式和中斷狀態等資訊

## CPU 與記憶體/IO 的互動

CPU 透過三種匯流排與記憶體和 I/O 裝置通訊：

1. **位址匯流排 (Address Bus)**：
   - CPU 用來選擇要存取的記憶體位址或 I/O 裝置
   - 單向匯流排 (CPU → 記憶體/I/O)
   
2. **資料匯流排 (Data Bus)**：
   - 用於在 CPU 和記憶體/I/O 之間傳輸資料
   - 雙向匯流排 (CPU ↔ 記憶體/I/O)
   
3. **控制匯流排 (Control Bus)**：
   - 用於傳送控制信號，如讀/寫命令
   - 包含時脈信號、讀/寫信號、中斷信號等

## 暫存器使用範例

### 基本資料移動

```assembly
MOV R0, #42        ; 將立即值 42 載入到 R0
MOV R1, R0         ; 將 R0 的值複製到 R1
```

### 暫存器間算術運算

```assembly
ADD R2, R0, R1     ; R2 = R0 + R1
SUB R3, R2, #10    ; R3 = R2 - 10
```

### 使用特殊暫存器

```assembly
MOV R0, LR         ; 將 LR (R14) 的值複製到 R0
MOV PC, LR         ; 將 LR 的值複製到 PC (R15)，實現返回
```

## 返回

- [[ARM架構與組合語言程式設計|返回第二章目錄]]
- [[微處理機概述|返回微處理機概述]]
