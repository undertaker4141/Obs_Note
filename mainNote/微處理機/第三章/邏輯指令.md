# 邏輯指令

本節介紹 ARM 處理器中的邏輯指令，包括位元 AND、OR、XOR、位元清除和位元反相等操作。

## 基本邏輯指令

ARM 提供了一組完整的邏輯指令，用於位元操作：

### AND 指令

```assembly
AND Rd, Rn, Op2    ; Rd = Rn AND Op2
ANDS Rd, Rn, Op2   ; 同上，並更新旗標
```

AND 指令執行位元與操作，只有當兩個輸入位都為 1 時，結果位才為 1。

**常見用途**：
- 清除特定位元 (與 0 進行 AND)
- 保留特定位元 (與 1 進行 AND)
- 檢查特定位元是否設置 (與位元遮罩進行 AND，然後檢查結果)

**範例**：
```assembly
AND R0, R0, #0x0F   ; 清除 R0 的高 4 位，保留低 4 位
```

### ORR 指令

```assembly
ORR Rd, Rn, Op2    ; Rd = Rn OR Op2
ORRS Rd, Rn, Op2   ; 同上，並更新旗標
```

ORR 指令執行位元或操作，當任一輸入位為 1 時，結果位為 1。

**常見用途**：
- 設置特定位元 (與 1 進行 OR)
- 合併兩個值

**範例**：
```assembly
ORR R0, R0, #0x80   ; 設置 R0 的最高位 (bit 7)
```

### EOR 指令

```assembly
EOR Rd, Rn, Op2    ; Rd = Rn XOR Op2
EORS Rd, Rn, Op2   ; 同上，並更新旗標
```

EOR (Exclusive OR) 指令執行位元異或操作，當兩個輸入位不同時，結果位為 1。

**常見用途**：
- 切換特定位元 (與 1 進行 XOR)
- 檢查兩個值是否相等 (XOR 結果為 0 則相等)
- 簡單的加密/解密

**範例**：
```assembly
EOR R0, R0, #0x01   ; 切換 R0 的最低位 (bit 0)
```

### BIC 指令

```assembly
BIC Rd, Rn, Op2    ; Rd = Rn AND NOT Op2
BICS Rd, Rn, Op2   ; 同上，並更新旗標
```

BIC (Bit Clear) 指令執行位元清除操作，相當於 `Rn AND NOT Op2`。

**常見用途**：
- 清除特定位元 (與 1 進行 BIC)

**範例**：
```assembly
BIC R0, R0, #0xF0   ; 清除 R0 的高 4 位，保留其他位不變
```

### MVN 指令

```assembly
MVN Rd, Op2        ; Rd = NOT Op2
MVNS Rd, Op2       ; 同上，並更新旗標
```

MVN (Move Not) 指令執行位元反相操作，將 Op2 的每一位取反。

**常見用途**：
- 產生一個值的反相
- 與其他指令組合使用

**範例**：
```assembly
MVN R0, #0         ; R0 = 0xFFFFFFFF (所有位都是 1)
```

## 旗標更新

邏輯指令加上 `S` 後綴會更新 CPSR 中的 N, Z, C 旗標 (V 不受影響)：

- **N**：如果結果為負數 (最高位為 1)
- **Z**：如果結果為零
- **C**：通常保持不變，但在帶移位的邏輯指令中，C 會被設置為移出的最後一位

## 測試指令

ARM 提供了專門的測試指令，用於檢查位元狀態：

### TST 指令

```assembly
TST Rn, Op2    ; 測試 Rn AND Op2，只更新旗標
```

TST 指令執行 AND 操作但不儲存結果，只更新旗標。常用於檢查特定位元是否設置。

**範例**：
```assembly
TST R0, #0x01      ; 測試 R0 的最低位是否為 1
BNE BitIsSet       ; 如果位元已設置 (結果非零)，跳轉到 BitIsSet
```

### TEQ 指令

```assembly
TEQ Rn, Op2    ; 測試 Rn EOR Op2，只更新旗標
```

TEQ 指令執行 XOR 操作但不儲存結果，只更新旗標。常用於檢查兩個值是否相等。

**範例**：
```assembly
TEQ R0, R1         ; 測試 R0 和 R1 是否相等
BEQ Equal          ; 如果相等 (結果為零)，跳轉到 Equal
```

## 位元操作範例

### 設置特定位元

```assembly
; 設置 R0 的第 3 位 (bit 3)
ORR R0, R0, #(1<<3)    ; R0 |= (1<<3)
```

### 清除特定位元

```assembly
; 清除 R0 的第 5 位 (bit 5)
BIC R0, R0, #(1<<5)    ; R0 &= ~(1<<5)
```

### 切換特定位元

```assembly
; 切換 R0 的第 2 位 (bit 2)
EOR R0, R0, #(1<<2)    ; R0 ^= (1<<2)
```

### 檢查特定位元

```assembly
; 檢查 R0 的第 4 位 (bit 4) 是否設置
TST R0, #(1<<4)        ; 測試 bit 4
BNE BitIsSet           ; 如果設置，跳轉到 BitIsSet
```

### 提取特定位元

```assembly
; 提取 R0 的第 6 位 (bit 6) 到 R1
AND R1, R0, #(1<<6)    ; 保留 bit 6，清除其他位
LSR R1, R1, #6         ; 右移 6 位，將結果移到最低位
```

## 返回

- [[ARM算術與邏輯指令|返回第三章目錄]]
- [[微處理機概述|返回微處理機概述]]
