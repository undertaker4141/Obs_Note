---
banner: 模板/banner.jpg
banner_y: "86.5"
---
# 行程 (Processes)

(來源: c10_processes.pdf)

## 簡介

- 行程 (Process) 是執行中的程式。程式可以是組合語言碼、高階語言編譯後的可執行碼 (如 C++)，或直譯式語言碼 (如 Shell script, Perl)。
    
- 每次執行外部指令時，UNIX 系統都會建立一個行程；指令執行完畢後，行程會被移除。
    
- 在分時系統 (Time-sharing system) 如 UNIX 中，允許多個使用者同時執行多個行程。
    

## CPU 排程：同時執行多個行程

- 在單 CPU 系統中，透過快速地在行程間切換 CPU 來達成多行程同時執行的效果。
    
- 一個行程在 CPU 中執行的時間片段稱為 **量時 (quantum)** 或 **時間配額 (time slice)**，通常很短 (例如 UNIX 中小於 1 秒)。
    
- 當 CPU 空閒或目前行程用完其量時，核心 (kernel) 會使用演算法決定下一個使用 CPU 的行程，此過程稱為 **CPU 排程 (CPU scheduling)**。
    
- 執行此任務的核心程式碼稱為 **短期 CPU 排程器 (short-term CPU scheduler)** 或 CPU 排程器。
    
- 將 CPU 從目前執行行程移交給新排程行程的過程稱為 **內容切換 (context switching)**，由核心的 **分派器 (dispatcher)** 執行。
    
- 即使在多 CPU 或多核心 CPU 系統中，若行程數量多於 CPU/核心數量，CPU 排程和內容切換仍然會發生。
    

### 指派優先權值

- 分時系統中，每個行程都被指派一個優先權值，最高優先權的行程下一個使用 CPU。
    
- **先到先服務 (First-Come, First-Serve, FCFS)**：最早進入系統的行程獲得最高優先權。
    
- **基於 CPU 使用時間**：新到達的行程或主要執行 I/O 操作的行程 (I/O-bound process，如文字編輯器 `vim`) 獲得較高優先權。
    
- **循環分配 (Round Robin, RR)**：CPU 依序分配給佇列中的每個行程一個量時。
    
- UNIX System V 排程演算法是上述演算法的混合體，使用公式計算每個準備執行行程的優先權值，優先權值最小的行程優先執行。
    
    - `優先權值 = 臨界優先權 + nice 值 + (最近 CPU 使用量 / 2)`
        
    - **臨界優先權 (Threshold priority)**：系統指派的基礎值 (通常 40 或 60)，反映行程類型 (系統 vs. 使用者)。
        
    - **Nice 值 (Nice value)**：使用者可控制的調整值 (-20 高優先權 到 19 低優先權，預設通常為 10)。非超級使用者不能設為負值。較高的 nice 值意味著較低的實際優先權。
        
    - **最近 CPU 使用量 (Recent CPU usage)**：行程最近使用的 CPU 時脈週期數。使用越多，此值越高，實際排程優先權越低。
        
- 使用者可使用 `nice` 或 `renice` 指令調整其行程的 nice 值。
    

## UNIX 行程狀態

行程會經歷不同狀態，最終正常或異常終止。

- **正常終止**：完成任務並乾淨地退出系統。
    
- **異常終止**：由於例外 (如執行時期錯誤) 或使用者/超級使用者干預 (如 `kill` 指令或 `<Ctrl+C>`)。
    

主要 UNIX 行程狀態：

- **就緒 (Ready)**：行程準備執行，但沒有 CPU。
    
- **執行中 (Running)**：行程正在使用 CPU。
    
- **等待 (Waiting)**：行程等待某個事件發生，如 I/O 完成、子行程結束、或被喚醒 (從睡眠中)。
    
- **已交換 (Swapped)**：行程準備執行，但暫時被移到磁碟交換空間 (swap space)，可能因記憶體不足。
    
- **殭屍 (Zombie)**：垂死的行程。通常發生在父行程在子行程呼叫 `exit` 前終止。殭屍行程已完成執行，不佔用記憶體，但仍分配了一些核心資源。最終會被 `init` 行程 (PID 1) 收養並從系統中移除。
    

## Shell 指令的執行

- **內部指令 (Internal Commands)**：Shell 行程本身的一部分，執行較快，不需額外建立行程。例如：`.` (dot command), `bg`, `cd`, `echo`, `exit`, `export`, `fg`, `jobs`, `pwd`, `read`, `set`, `umask`, `wait`。
    
- **外部指令 (External Commands)**：獨立的可執行檔 (二進位或腳本)，通常位於 `/bin`, `/usr/bin` 等目錄。執行時會派生 (fork) 一個新行程。例如：`grep`, `more`, `cat`, `ls`, `sort`。
    
- `type` 指令可判斷指令是內部或外部。`type -a` (Bash 中) 可顯示指令的所有位置。
    

### 行程建立與執行

1. **`fork()` 系統呼叫**：UNIX 行程使用 `fork()` 建立一個新行程 (子行程)，子行程是父行程記憶體的精確副本。父子行程都從 `fork()` 之後的敘述開始繼續執行。
    
2. **`exec()` 系統呼叫**：使一個行程用新的程式替換其目前的程式。
    

- Shell 通常先 `fork()` 一個子行程，然後子行程再 `exec()` 外部指令。父 Shell 會等待子行程 (指令) 完成。
    

### Shell 腳本的執行

- 目前 Shell (`fork()`) 一個子 Shell。
    
- 子 Shell 逐一執行腳本中的指令。腳本中的每個外部指令都會再由子 Shell `fork()` 和 `exec()`。
    
- 父 Shell 等待子 Shell 結束。子 Shell 執行到腳本檔尾 (EOF) 時終止。
    
- 除非腳本中特別指定 (如 `#!/bin/bash`)，子 Shell 的類型與父 Shell 相同。
    
- 可以透過在腳本第一行指定 `#!<shell路徑>` 來強制使用特定 Shell 執行腳本。
    
- 也可以在目前 Shell 中執行另一個 Shell 作為子 Shell (subshell)，並在其中執行指令。
    

## 行程屬性

行程具有多種屬性，包括：

- 擁有者 ID (UID)
    
- 行程 ID (PID)
    
- 父行程 ID (PPID)
    
- 行程名稱
    
- 行程狀態
    
- 啟動行程的指令
    
- 行程優先權
    
- 行程啟動時間
    
- CPU 時間消耗百分比
    
- 主記憶體消耗百分比
    
- 虛擬記憶體大小 (VSZ)
    
- 實際記憶體大小 (RSS)
    
- 等待事件 (如果不在執行中)
    
- 已執行時間
    

## 行程屬性的靜態顯示 (`ps`)

- `ps` 指令用於檢視系統中目前行程屬性的快照。不同 UNIX 版本 (如 PC-BSD, Solaris, Linux) 的 `ps` 指令選項可能有所不同，但核心功能相似。
    
- **基本輸出欄位 (PC-BSD 範例)**:
    
    - `PID`: 行程 ID。
        
    - `TT`: 行程附加的終端機。
        
    - `STAT`: 行程狀態 (如 `Ss` - 休眠的會話領導者, `R+` - 前景可執行的)。
        
    - `TIME`: 行程已消耗的 CPU 時間。
        
    - `COMMAND`: 啟動行程的指令。
        
- **常用選項 (部分通用)**:
    
    - `-u [username]`: 顯示指定使用者的行程詳細資訊 (如 `%CPU`, `%MEM`, `VSZ`, `RSS`, `STARTED`)。
        
    - `-U [username_list]`: 顯示指定使用者列表的行程預設狀態。
        
    - `-G [group_id_list]`: 顯示指定群組 ID 的行程。
        
    - `-a`: 顯示您和其他使用者的行程。
        
    - `-x`: 顯示沒有控制終端機的行程 (包括守護行程 daemons)。
        
    - `-e` (Linux/Solaris) 或 `-ax` (BSD): 顯示所有行程。
        
    - `-l`: 長列表格式，顯示更多欄位 (如 `UID`, `PPID`, `PRI`, `NICE`)。
        
    - `-f` (Linux/Solaris): 全格式列表。
        
    - `-o keyword1,keyword2=HEADER,...`: 自訂顯示欄位及其標頭。
        
    - `-H`: 顯示核心可見的執行緒 (threads)，在 Solaris 中稱為輕量級行程 (LWPs)。
        
- 計算執行中行程數量：`ps -ax | wc -l` (BSD)，結果需減去標頭行和 `ps`, `wc` 本身。Solaris/Linux 可用 `ps -e | wc -l`。
    

[[Unix學習筆記_總覽]]